services:
  feedgen:
    image: ghcr.io/erikologic/feed-generator:latest
    volumes:
      - feedgen_data:/data
    environment:
      - FEEDGEN_PORT=3000
      - FEEDGEN_LISTENHOST=0.0.0.0
      - FEEDGEN_SQLITE_LOCATION=/data/db.sqlite
      - FEEDGEN_SUBSCRIPTION_ENDPOINT=wss://relay.${PARTITION}.${DOMAIN}
      - FEEDGEN_HOSTNAME=feedgen.${PARTITION}.${DOMAIN}
      - FEEDGEN_SUBSCRIPTION_RECONNECT_DELAY=3000
    depends_on:
      traefik-https-check:
        condition: service_healthy
      relay:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.feedgen.rule=Host(`feedgen.${PARTITION}.${DOMAIN}`)"
      - "traefik.http.routers.feedgen.entrypoints=websecure"
      - "traefik.http.routers.feedgen.tls.certresolver=letsencrypt"
      - "traefik.http.services.feedgen.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/.well-known/did.json || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  prepare:
    image: alpine:latest
    depends_on:
      traefik-https-check:
        condition: service_healthy
      pds:
        condition: service_healthy
      relay:
        condition: service_healthy
      feedgen:
        condition: service_healthy
    working_dir: /app
    environment:
      - RELAY_HOST=relay.${PARTITION}.${DOMAIN}
      - PDS_HOST=pds.${PARTITION}.${DOMAIN}
      - FEEDGEN_HOST=feedgen.${PARTITION}.${DOMAIN}
    volumes:
      - ./prepare.sh:/app/prepare.sh:ro
      - feedgen_publisher_did:/shared
    command: sh -c "apk add --no-cache curl && sh /app/prepare.sh"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/ready"]
      interval: 2s
      timeout: 1s
      retries: 3
      start_period: 5s

volumes:
  feedgen_data:
  feedgen_publisher_did:
