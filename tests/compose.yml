services:
  e2e-jest:
    profiles: ["test"]
    image: node:22-alpine
    working_dir: /app
    environment:
      - DOMAIN=${DOMAIN}
      - PARTITION=${PARTITION}
    volumes:
      - ./api:/app/tests/api
      - ./jest.config.js:/app/jest.config.js
      - ../package-lock.json:/app/package-lock.json
      - ../package.json:/app/package.json
      - ../tsconfig.json:/app/tsconfig.json
    depends_on:
      feedgen-post-setup:
        condition: service_healthy
      jetstream:
        condition: service_healthy
      bsky:
        condition: service_healthy
    command: >
      sh -c "npm install && npm test"

  e2e-playwright:
    profiles: ["test"]
    image: mcr.microsoft.com/playwright:v1.55.1-noble
    working_dir: /app
    environment:
      - DOMAIN=${DOMAIN}
      - PARTITION=${PARTITION}
      - CI=true
    volumes:
      - ./ui:/app/tests/ui
      - ./playwright.config.ts:/app/playwright.config.ts
      - ../package-lock.json:/app/package-lock.json
      - ../package.json:/app/package.json
      - ../tsconfig.json:/app/tsconfig.json
      - ../playwright-report:/app/playwright-report
      - ../test-results:/app/test-results
    depends_on:
      e2e-jest:
        condition: service_completed_successfully
      social:
        condition: service_started
    command: >
      sh -c "npm install && npm run test:browser"
